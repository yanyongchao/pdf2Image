<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PDF转图片示例</title>
  <style>
    .page-image {
      margin: 10px 0;
      max-width: 100%;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
    }
  </style>
  <!-- 引入 vConsole -->
  <script src="https://unpkg.com/vconsole@latest/dist/vconsole.min.js"></script>
</head>

<body>
  <h1>PDF转图片</h1>
  <div id="output"></div>
  <script src="/pdf.js"></script>
</body>

<script>
  // 初始化 vConsole
  var vConsole = new VConsole();
  console.log('vConsole 已启用');

  pdfjsLib.GlobalWorkerOptions.workerSrc = '/pdf.worker.js';

  async function loadPDFFile(loadingTask) {
    const start = Date.now()
    const outputDiv = document.getElementById('output');
    outputDiv.innerHTML = ''; // 清空之前的内容

    const pdf = await loadingTask.promise;
    console.log('pdf页数: ', pdf.numPages);

    for (let curPage = 1; curPage <= pdf.numPages; curPage++) {
      console.log('正在处理第', curPage, '页');
      const page = await pdf.getPage(curPage);

      const scale = 1.5;
      const viewport = page.getViewport({ scale });

      // 创建canvas元素
      const canvas = document.createElement('canvas');
      const context = canvas.getContext('2d');

      // 设置canvas尺寸
      canvas.width = viewport.width;
      canvas.height = viewport.height;

      // 渲染PDF页面到canvas
      const renderContext = {
        canvasContext: context,
        viewport: viewport
      };

      await page.render(renderContext).promise;

      // 将canvas转换为图片
      const image = new Image();
      image.src = canvas.toDataURL('image/png');
      image.className = 'page-image';
      image.style.width = '100%';
      image.style.height = 'auto';

      // 添加页码标识
      const pageDiv = document.createElement('div');
      pageDiv.style.marginBottom = '20px';
      pageDiv.innerHTML = `<p style="margin: 5px 0">第 ${curPage} 页</p>`;
      pageDiv.appendChild(image);

      outputDiv.appendChild(pageDiv);
    }

    console.log('耗时: ', Date.now() - start)
  }

  // 直接加载指定URL的PDF
  const pdfUrl = 'https://yyc-oss-bucket.oss-cn-beijing.aliyuncs.com/%E7%BD%91%E6%A0%BC%E5%B8%83%E5%B1%80%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97.pdf';

  // 添加加载提示
  const outputDiv = document.getElementById('output');
  outputDiv.innerHTML = '<p>正在加载PDF，请稍候...</p>';

  // 使用fetch获取PDF文件
  fetch(pdfUrl)
    .then(response => response.arrayBuffer())
    .then(arrayBuffer => {
      const loadingTask = pdfjsLib.getDocument(new Uint8Array(arrayBuffer));
      loadPDFFile(loadingTask);
    })
    .catch(error => {
      console.error('加载PDF出错:', error);
      outputDiv.innerHTML = '<p style="color: red;">PDF加载失败，请检查网络连接或PDF地址是否正确。</p>';
    });

</script>

</html>